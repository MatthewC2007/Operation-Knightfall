import json
from kivy.uix.widget import Widget
from kivy.app import App
from kivy.uix.behaviors import DragBehavior
from kivy.lang import Builder
from kivy.uix.screenmanager import ScreenManager, Screen

# KV language definition
kv = '''
<DraggableRectangle@DragBehavior+Widget>:
    drag_timeout: 10000000
    drag_distance: 0
    drag_rectangle: self.x, self.y, self.width, self.height

    canvas:
        Color:
            rgba: 1, 0, 0, 1  # Red color
        Rectangle:
            pos: self.pos
            size: self.size

<WelcomeScreen>:
    FloatLayout:
        Label:
            text: "Welcome to the App!"
            font_size: 32
            size_hint: 0.6, 0.2
            pos_hint: {"center_x": 0.5, "center_y": 0.6}
        Button:
            text: "Enter"
            size_hint: 0.1, 0.1
            pos_hint: {"center_x": 0.5, "center_y": 0.4}
            border: 10,10,10,10
            on_release: app.switch_to_main_screen()

<MainScreen>:
    FloatLayout:
        DraggableRectangle:
            id: rect1
            size_hint: 0.1, 0.1
        Button:
            text: 'Quit'
            size_hint: 0.2, 0.1
            pos_hint: {"x": 0.79, "y": 0.05}
            border: 10,10,10,10
            on_release: app.stop()
        Button:
            text: 'New Rectangle'
            size_hint: 0.2, 0.1
            pos_hint: {"x": 0.02, "y": 0.05}
            border: 10,10,10,10
            on_release: app.add_new_rectangle()
'''

class WelcomeScreen(Screen):
    pass

class MainScreen(Screen):
    pass

class DraggableRectangle(DragBehavior, Widget):
    pass

class MainApp(App):
    def build(self):
        # Load the KV string
        Builder.load_string(kv)

        # Create the ScreenManager and add screens
        self.sm = ScreenManager()
        self.sm.add_widget(WelcomeScreen(name="welcome"))
        self.sm.add_widget(MainScreen(name="main"))

        # Set the initial screen to "welcome"
        self.sm.current = "welcome"

        # Load the saved position for the rectangle
        self.position = self.load_position()

        return self.sm

    def switch_to_main_screen(self):
        """Switch to the main screen."""
        self.sm.current = "main"

        # Access the DraggableRectangle and set its position
        main_screen = self.sm.get_screen("main")
        draggable = main_screen.ids.rect1
        if self.position:
            draggable.pos = self.position  # Set the saved position
        else:
            # Set the position to center it manually if no saved position exists
            draggable.pos = (
                (main_screen.width - draggable.width) / 2,
                (main_screen.height - draggable.height) / 2
            )

        # Bind the position to save it when the rectangle is moved
        draggable.bind(pos=lambda instance, value: self.save_position(instance.pos))

    def add_new_rectangle(self):
        """Add a new draggable rectangle to the main screen."""
        main_screen = self.sm.get_screen("main")
        layout = main_screen.children[0]  # Access the FloatLayout

        # Create a new DraggableRectangle
        new_rectangle = DraggableRectangle()
        new_rectangle.size_hint = (0.2, 0.2)
        new_rectangle.pos = (100, 100)  # Set an initial position

        # Add the new rectangle to the layout
        layout.add_widget(new_rectangle)

    def save_position(self, position):
        """Save the rectangle's position to a file."""
        with open("position.json", "w") as f:
            json.dump({"x": position[0], "y": position[1]}, f)

    def load_position(self):
        """Load the rectangle's position from a file."""
        try:
            with open("position.json", "r") as f:
                data = json.load(f)
                return (data["x"], data["y"])
        except (FileNotFoundError, KeyError, json.JSONDecodeError):
            return None


if __name__ == '__main__':
    MainApp().run()